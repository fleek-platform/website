#!/bin/bash

if [[ -z "$1" || -z "$2" ]]; then
  echo "ğŸ‘¹ Oops! Missing argument for the application distribution path ($1) or env vars prefix ($2)..."

  exit 1
fi

targetAppDistPath="$1"
envVarsPrefix="$2"
tempJson="dump.json"
definedOverridesJson="$targetAppDistPath/defined_overrides.json"

echo "ğŸ¤– Will attempt to generate $definedOverridesJson..."

if ! doppler secrets download \
  --no-file \
  --format=json > "$tempJson"; then
  echo "ğŸ‘¹ Oops! Failed to get doppler's data..."

  exit 1
fi

cat "$tempJson" | jq "with_entries(select(.key | startswith(\"$envVarsPrefix\") ))" > "$definedOverridesJson"

if ! rm "$tempJson"; then
  echo "âš ï¸Warning: Failed to delete $tempJson"
fi

echo "ğŸ’¡ Created $definedOverridesJson which content is:"
cat "$definedOverridesJson"

echo
echo "âœ… Completed defined override setup!"
